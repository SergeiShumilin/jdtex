\documentclass[a4paper,10pt]{extarticle}                     % a4 document with font 14pt

\usepackage[top=2cm,left=2cm,right=2cm,bottom=2cm]{geometry} % margins
\usepackage[utf8]{inputenc}                                  % for MikTex editor support
\usepackage[T2A]{fontenc}                                    % for russian encoding support
\usepackage[russian]{babel}                                  % russian encoding on
\usepackage{amsmath,amsthm,amscd,amsfonts,amssymb}           % special symbols, etc.
\usepackage{indentfirst}                                     % paragraph first word indentation
\usepackage{textcomp}                                        % text in formulas
\usepackage{graphicx}                                        % graphics on

\numberwithin{equation}{section}                             % section numbering for formulas
\numberwithin{figure}{section}                               % section numbering for pictures

\theoremstyle{plain}                                         % theorem style
\newtheorem{theorem}{Теорема}[section]                       % theorem
\newtheorem{lemma}{Лемма}[section]                           % lemma
\newtheorem{definition}{Определение}[section]                % definition

\begin{document}

\title{TODO: name of article}
\author{Алексей Рыбаков \\ rybakov.aax@gmail.com}
\date{Март, 2015}
\maketitle

\section{Основные соглашения и определения}

Точку в пространстве будем задавать ее радиус-вектором - вектором, направленным из начала координат в рассматриваемую точку ($\overline{P}$).

Прямую в трехмерном пространстве будем задавать \textit{опорной точкой} $\overline{P_0}$ и \textit{направляющим вектором} $\overline{V}$ ($L = (\overline{P_0}, \overline{V})$).
Геометрическое место точек прямой описывается следующим образом:

\begin{equation}
    L = \{ \overline{P(t)} = \overline{P_0} + t\overline{V} \ | \ t \in \mathbb{R} \}.
\end{equation}

Сферу в трехмерном пространстве будем задавать ее центром $\overline{C}$ и радиусом $R$ ($S = (\overline{C}, R)$).
Геометрическое место точек поверхности сферы описывается следующим образом:

\begin{equation}
    S = \{ \overline{P} \ | \ {|\overline{P} - \overline{C}|}^2 = R^2 \}.
\end{equation}

\begin{definition}
Пучком сфер, опирающимся на отрезок, концами которого являются точки пространства $\overline{C_1}$ и $\overline{C_2}$, будем называть семейство сфер $S(\alpha) = (\overline{C(\alpha)}, R(\alpha))$, где центры и радиусы сфер задаются следующими соотношениями:
\begin{equation}
    \begin{cases}
        \overline{C(\alpha)} = \overline{C_1} + \alpha(\overline{C_2} - \overline{C_1}) = \overline{C_1} + \alpha \overline{\Delta C}, \\
        R(\alpha) = R_1 + \alpha(R_2 - R_1) = R_1 + \alpha \Delta R,
    \end{cases}
\end{equation}
где $\alpha \in [0; 1]$.
Обозначать пучок сфер будем
\begin{equation}
    \mathbb{S}(S(\alpha \in [0; 1])) = \mathbb{S}(S_1, S_2),
\end{equation}
где $S_1 = (\overline{C_1}, R_1), \ S_2 = (\overline{C_2}, R_2)$.
\end{definition}

\section{Поиск точек пересечения прямой со сферой}

Пусть дана прямая $L = (\overline{P_0}, \overline{V})$ и сфера $S = (\overline{C}, R)$.
Требуется найти точки их пересечения.
Таких точек может не быть, быть ровно одна (в случае касания) или быть две.
Для поиска точек пересечения требуется решить следующую систему уравнений относительно $t$:

\begin{equation}
    \begin{cases}
        \overline{P} = \overline{P_0} + t\overline{V}, \\
        {|\overline{P} - \overline{C}|}^2 = R^2.
    \end{cases}
\end{equation}

Без ограничения общности можно считать, что $\overline{P_0} = \overline{0}$, так как мы всегда можем добиться этого с помощью замены:

\begin{equation}
    \begin{cases}
        \overline{P_0'} = \overline{0}, \\
        \overline{C'} = \overline{C} - \overline{P_0}.
    \end{cases}
\end{equation}

Таким образом, требуется решить следующую систему уравнений относительно $t$:

\begin{equation}
    \begin{cases}
        \overline{P} = t\overline{V}, \\
        {|\overline{P} - \overline{C}|}^2 = R^2.
    \end{cases}
\end{equation}

Подставляя $\overline{P}$ из первого уравнения во второе, получим квадратное уравнение относительно $t$:

\begin{eqnarray}
    {|t\overline{V} - \overline{C}|}^2 = R^2, \\
    {|\overline{V}|}^2t^2 - 2(\overline{C}\cdot\overline{V})t + ({|\overline{C}|}^2 - R^2) = 0.
\end{eqnarray}

Дискриминант этого уравнения равен $4\left((\overline{C}\cdot\overline{V})^2 - {|\overline{V}|}^2({|\overline{C}|}^2 - R^2)\right)$.
Так как значение дискриминанта может быть вычислено непосредственно, то дальнейший поиск точек пересечения не представляет сложности.
Если значение дискриминанта отрицательно, то точек пересечения нет.
Если значение дискриминанта положительно, то точек пересечения ровно две.
Равенство дискриминанта нулю означает касание прямой и сферы.

\section{Поиск точек пересечения прямой с пучком сфер}

Пусть дана прямая $L = (\overline{0}, \overline{V})$ (как и в предыдущем пункте без ограничения общности считаем, что опорная точка совпадает с началом координат) и пучок сфер $\mathbb{S}(S_1, S_2)$.
Требуется найти точки их пересечения.
Прямая может не пересекать пучок сфер, может касаться его в одной точке или пересекать по отрезку.
В случае, когда множество точек пересечения прямой и пучка сфер является отрезком, нужно найти концы этого отрезка, так что в дальнейшем под точками пересечения прямой и пучка сфер будем понимать именно данные точки.

Для решения задачи сначала необходимо найти все сферы из пучка, с которыми пересекается данная прямая.
Из предыдущего пункта видно, что прямая пересекается со сферой $S(\alpha) = (\overline{C(\alpha)}, R(\alpha))$, если выполняется условие:

\begin{equation}
    (\overline{C(\alpha)}\cdot\overline{V})^2 - {|\overline{V}|}^2({|\overline{C(\alpha)}|}^2 - R(\alpha)^2) \ge 0.
\end{equation}

Подставляя в данной неравенство выражения для $\overline{C(\alpha)}$ и $R(\alpha)$, получим

\begin{equation}
    \left((\overline{C_1} + \alpha\overline{\Delta C})\cdot\overline{V}\right)^2 - {|\overline{V}|}^2\left((\overline{C_1} + \alpha\overline{\Delta C})^2 - (R_1 + \alpha \Delta R)^2\right) \ge 0.
\end{equation}

После раскрытия скобок получим квадратное неравенство относительно параметра $\alpha$:

\begin{equation}
    A_2 \alpha^2 + 2A_1 \alpha + A_0 \ge 0,
\end{equation}

где

\begin{equation}
    \begin{cases}
        A_2 = (\overline{\Delta C}\cdot\overline{V})^2 + |\overline{V}|^2({\Delta R}^2 - |\overline{\Delta C}|^2), \\
        A_1 = (\overline{C_1}\cdot\overline{V})\cdot(\overline{\Delta C}\cdot\overline{V}) + |\overline{V}|^2(R_1\Delta R - (\overline{C_1}\cdot\overline{\Delta C})), \\
        A_0 = (\overline{C_1}\cdot\overline{V})^2 + |\overline{V}|^2(R_1^2 - |\overline{C_1}|^2).
    \end{cases}
\end{equation}

Полученное неравенство можно решить относительно $\alpha$, так как коэффициенты $A_2, A_1, A_0$ известны.
Нас интересует только решение данного неравенства на отрезке $[0; 1]$, оно представляет собой либо пустое множество, либо отрезок.

TODO: краевые случаи.

Если на отрезке $[0; 1]$ приведенное неравенство не имеет решения, то прямая не пересекает пучок сфер.
Допустим решением приведенного неравенства на отрезке $[0; 1]$ явялется отрезок $[\alpha_1, \alpha_2] \subseteq [0; 1]$.

Для произвольного $\alpha \in [\alpha_1; \alpha_2]$ корни уравнения ${|\overline{V}|}^2t^2 - 2(\overline{C(\alpha)}\cdot\overline{V})t + ({|\overline{C(\alpha)}|}^2 - R(\alpha)^2) = 0$ существуют и выражаются следующим образом:

\begin{equation}
    t_{1,2}(\alpha) = \frac{(\overline{C(\alpha)}\cdot\overline{V}) \pm \sqrt{A_2\alpha^2 + 2A_1\alpha + A_0}}{|\overline{V}|^2}.
\end{equation}

Искомые точки пересечения прямой с пучком сфер соответствуют минимальному и максимальному значению $t(\alpha)$, достигаемым на отрезке $\alpha \in [\alpha_1; \alpha_2]$.
Максимальное и минимальное значение $t(\alpha)$ может достигаться либо в точках $\alpha = \alpha_1, \ \alpha = \alpha_2$, либо в точке локального экстремума.
Для точки локального экстремума должно быть выполнено соотношение:

\begin{equation}\label{eqn:t_12_der_eq_0}
    t_{1,2}'(\alpha) = 0.
\end{equation}

Перепишем формулу \ref{eqn:t_12_der_eq_0} в явном виде, в результате чего получим следующее уравнение относительно $\alpha$:

\begin{eqnarray}
    (\overline{\Delta C}\cdot\overline{V}) \pm \frac{A_2\alpha + A_1}{\sqrt{A_2\alpha^2 + 2A_1\alpha + A_0}} = 0, \\
    q(A_2\alpha^2 + 2A_1\alpha + A_0) = (A_2\alpha + A_1)^2,
\end{eqnarray}

где $q = (\overline{\Delta C}\cdot\overline{V})^2$.
После преобразования получим следующее уравнение относительно $\alpha$:

\begin{equation}\label{eqn:alpha_eqn}
    A_2(q - A_2)\alpha^2 + 2A_1(q - A_2)\alpha + (qA_0 - A_1^2) = 0,
\end{equation}

решая которое, получим потенциальные точки локальных экстремумов $\hat{\alpha_1}, \hat{\alpha_2}$.
Данные точки локальных экстремумов следует учитывать только если они попадают в отрезок $[\alpha_1, \alpha_2]$.

В общем случае значения $t_{1,2}$ находятся по четырем значениям $\alpha$:

\begin{align}
    t_1 = \min\{t_1(\alpha_1), t_1(\alpha_2), t_1(\hat{\alpha_1}), t_1(\hat{\alpha_2})\}, \\
    t_2 = \max\{t_2(\alpha_1), t_2(\alpha_2), t_2(\hat{\alpha_1}), t_2(\hat{\alpha_2})\}.
\end{align}

По найденным значениям $t_{1, 2}$ уже непосредственно находятся точки пересечения прямой с пучком сфер.

\end{document}

